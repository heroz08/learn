Skip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading complete
Skip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading completeSkip to content
Search or jump toâ€¦
Pull requests
Issues
Marketplace
Explore
 
@heroz08 
liuxing
/
node-abc
Public
Code
Issues
4
Pull requests
1
Actions
Projects
Wiki
Security
Insights
node-abc/lesson5/
Latest commit
@liuxing
liuxing ğŸ“ Nodeä¸­çš„stream (æµ)
0fa823e
on 19 Apr 2017
Git stats
 History
Files
Type
Name
Latest commit message
Commit time
.â€Š.
copy
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
README.md
ğŸ“ Nodeä¸­çš„stream (æµ)
5 years ago
Stream.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
compress.js
ğŸš§ Nodeä¸­çš„stream
5 years ago
README.md
 Nodeå…¥é—¨æ•™ç¨‹-Nodeä¸­çš„stream (æµ)
ä¼ é€é—¨ï¼šGitHubåœ°å€

æµï¼ˆstreamï¼‰åœ¨ Node.js ä¸­æ˜¯å¤„ç†æµæ•°æ®çš„æŠ½è±¡æ¥å£ï¼ˆabstract interfaceï¼‰ã€‚ stream æ¨¡å—æä¾›äº†åŸºç¡€çš„ API ã€‚ä½¿ç”¨è¿™äº› API å¯ä»¥å¾ˆå®¹æ˜“åœ°æ¥æ„å»ºå®ç°æµæ¥å£çš„å¯¹è±¡ã€‚

Node.js æä¾›äº†å¤šç§æµå¯¹è±¡ã€‚ ä¾‹å¦‚ï¼Œ HTTP è¯·æ±‚ å’Œ process.stdout å°±éƒ½æ˜¯æµçš„å®ä¾‹ã€‚æµå¯ä»¥æ˜¯å¯è¯»çš„ã€å¯å†™çš„ï¼Œæˆ–æ˜¯å¯è¯»å†™çš„ã€‚æ‰€æœ‰çš„æµéƒ½æ˜¯ EventEmitter *(Nodeäº‹ä»¶æœºåˆ¶å°†åœ¨åç»­è®²è§£ï¼Œå¯ä»¥å…ˆè‡ªè¡Œäº†è§£)*çš„å®ä¾‹ã€‚

å°½ç®¡æ‰€æœ‰çš„ Node.js ç”¨æˆ·éƒ½åº”è¯¥ç†è§£æµçš„å·¥ä½œæ–¹å¼ï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼Œ ä½†æ˜¯ stream æ¨¡å—æœ¬èº«åªå¯¹äºé‚£äº›éœ€è¦åˆ›å»ºæ–°çš„æµçš„å®ä¾‹çš„å¼€å‘è€…æœ€æœ‰ç”¨å¤„ã€‚ å¯¹äºä¸»è¦æ˜¯æ¶ˆè´¹æµçš„å¼€å‘è€…æ¥è¯´ï¼Œä»–ä»¬å¾ˆå°‘ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ã€‚

1.äº†è§£Node Stream(æµ)
æ•°æ®æµï¼ˆstreamï¼‰æ˜¯å¤„ç†ç³»ç»Ÿç¼“å­˜çš„ä¸€ç§æ–¹å¼ã€‚æ“ä½œç³»ç»Ÿé‡‡ç”¨æ•°æ®å—ï¼ˆchunkï¼‰çš„æ–¹å¼è¯»å–æ•°æ®ï¼Œæ¯æ”¶åˆ°ä¸€æ¬¡æ•°æ®ï¼Œå°±å­˜å…¥ç¼“å­˜ã€‚Nodeåº”ç”¨ç¨‹åºæœ‰ä¸¤ç§ç¼“å­˜çš„å¤„ç†æ–¹å¼ï¼Œç¬¬ä¸€ç§æ˜¯ç­‰åˆ°æ‰€æœ‰æ•°æ®æ¥æ”¶å®Œæ¯•ï¼Œä¸€æ¬¡æ€§ä»ç¼“å­˜è¯»å–ï¼Œè¿™å°±æ˜¯ä¼ ç»Ÿçš„è¯»å–æ–‡ä»¶çš„æ–¹å¼*(é‡ä¸Šå¤§æ–‡ä»¶å¾ˆå®¹æ˜“ä½¿å†…å­˜çˆ†ä»“)ï¼›ç¬¬äºŒç§æ˜¯é‡‡ç”¨â€œæ•°æ®æµâ€çš„æ–¹å¼ï¼Œæ”¶åˆ°ä¸€å—æ•°æ®ï¼Œå°±è¯»å–ä¸€å—ï¼Œå³åœ¨æ•°æ®è¿˜æ²¡æœ‰æ¥æ”¶å®Œæˆæ—¶ï¼Œå°±å¼€å§‹å¤„ç†å®ƒ(åƒæµæ°´ä¸€æ ·)*

Node.js ä¸­æœ‰å››ç§åŸºæœ¬çš„æµç±»å‹ï¼š
Readable - å¯è¯»çš„æµ (ä¾‹å¦‚ fs.createReadStream()).
Writable - å¯å†™çš„æµ (ä¾‹å¦‚ fs.createWriteStream()).
Duplex - å¯è¯»å†™çš„æµ (ä¾‹å¦‚ net.Socket).
Transform - åœ¨è¯»å†™è¿‡ç¨‹ä¸­å¯ä»¥ä¿®æ”¹å’Œå˜æ¢æ•°æ®çš„ Duplex æµ (ä¾‹å¦‚ zlib.createDeflate()).
æ‰€æœ‰çš„ Stream å¯¹è±¡éƒ½æ˜¯ EventEmitter çš„å®ä¾‹
å¸¸ç”¨çš„äº‹ä»¶æœ‰ï¼š

data - å½“æœ‰æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
end - æ²¡æœ‰æ›´å¤šçš„æ•°æ®å¯è¯»æ—¶è§¦å‘ã€‚
error - åœ¨æ¥æ”¶å’Œå†™å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯æ—¶è§¦å‘ã€‚
finish - æ‰€æœ‰æ•°æ®å·²è¢«å†™å…¥åˆ°åº•å±‚ç³»ç»Ÿæ—¶è§¦å‘ã€‚
å¯è¯»æµï¼ˆReadable streamsï¼‰
å¯è¯»æµï¼ˆReadable streamsï¼‰æ˜¯å¯¹æä¾›æ•°æ®çš„ æºå¤´ ï¼ˆsourceï¼‰çš„æŠ½è±¡

å¯è¯»æ•°æ®æµæœ‰ä¸¤ç§çŠ¶æ€ï¼šæµåŠ¨çŠ¶æ€å’Œæš‚åœçŠ¶æ€ã€‚å¤„äºæµåŠ¨çŠ¶æ€æ—¶ï¼Œæ•°æ®ä¼šå°½å¿«åœ°ä»æ•°æ®æºå¯¼å‘ç”¨æˆ·çš„ç¨‹åº(å°±åƒæµæ°´ä¸€æ ·)ï¼›å¤„äºæš‚åœæ€æ—¶ï¼Œå¿…é¡»æ˜¾å¼è°ƒç”¨stream.read()ç­‰æŒ‡ä»¤ï¼Œâ€œå¯è¯»æ•°æ®æµâ€æ‰ä¼šé‡Šæ”¾æ•°æ®ï¼Œ(å°±åƒæµæ°´çš„é—¸é—¨ï¼Œæ‰“å¼€å®ƒæ°´æ‰ç»§ç»­æµä¸‹å»)

å¯è¯»æµåœ¨åˆ›å»ºæ—¶éƒ½æ˜¯æš‚åœæ¨¡å¼ï¼Œæš‚åœæ¨¡å¼å’ŒæµåŠ¨æ¨¡å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

è¦ä»æš‚åœæ¨¡å¼åˆ‡æ¢åˆ°æµåŠ¨æ¨¡å¼ï¼Œæœ‰ä¸‹é¢ä¸‰ç§åŠæ³•ï¼š

ç»™â€œdataâ€äº‹ä»¶å…³è”äº†ä¸€ä¸ªå¤„ç†å™¨

æ˜¾å¼è°ƒç”¨resume()

è°ƒç”¨pipe()æ–¹æ³•å°†æ•°æ®é€å¾€ä¸€ä¸ªå¯å†™æ•°æ®æµ

è¦ä»æµåŠ¨æ¨¡å¼åˆ‡æ¢åˆ°æš‚åœæ¨¡å¼ï¼Œæœ‰ä¸¤ç§é€”å¾„ï¼š

å¦‚æœè¿™ä¸ªå¯è¯»çš„æµæ²¡æœ‰æ¡¥æ¥å¯å†™æµç»„æˆç®¡é“ï¼Œç›´æ¥è°ƒç”¨pause()
å¦‚æœè¿™ä¸ªå¯è¯»çš„æµä¸è‹¥å¹²å¯å†™æµç»„æˆäº†ç®¡é“ï¼Œéœ€è¦ç§»é™¤ä¸â€œdataâ€äº‹ä»¶å…³è”çš„æ‰€æœ‰å¤„ç†å™¨ï¼Œå¹¶ä¸”è°ƒç”¨unpipe() æ–¹æ³•æ–­å¼€æ‰€æœ‰ç®¡é“
å¯è¯»æµå¸¸ç”¨äº‹ä»¶ï¼š
readableï¼šåœ¨æ•°æ®å—å¯ä»¥ä»æµä¸­è¯»å–çš„æ—¶å€™å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨å¤„ç†å™¨é‡Œè°ƒç”¨read([size])æ–¹æ³•è¯»å–æ•°æ®ã€‚
dataï¼šæœ‰æ•°æ®å¯è¯»æ—¶å‘å‡ºã€‚å®ƒå¯¹åº”çš„å¤„ç†å™¨æœ‰ä¸€ä¸ªå‚æ•°ï¼Œä»£è¡¨æ•°æ®ã€‚å¦‚æœä½ åªæƒ³å¿«å¿«åœ°è¯»å–ä¸€ä¸ªæµçš„æ•°æ®ï¼Œç»™dataå…³è”ä¸€ä¸ªå¤„ç†å™¨æ˜¯æœ€æ–¹ä¾¿çš„åŠæ³•ã€‚å¤„ç†å™¨çš„å‚æ•°æ˜¯Bufferå¯¹è±¡ï¼Œå¦‚æœä½ è°ƒç”¨äº†Readableçš„setEncoding(encoding)æ–¹æ³•ï¼Œå¤„ç†å™¨çš„å‚æ•°å°±æ˜¯Stringå¯¹è±¡ã€‚
endï¼šå½“æ•°æ®è¢«è¯»å®Œæ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
closeï¼šå½“åº•å±‚çš„èµ„æºï¼Œå¦‚æ–‡ä»¶ï¼Œå·²å…³é—­æ—¶å‘å‡ºã€‚ä¸æ˜¯æ‰€æœ‰çš„Readableæµéƒ½ä¼šå‘å‡ºè¿™ä¸ªäº‹ä»¶ã€‚å¯¹åº”çš„å¤„ç†å™¨æ²¡æœ‰å‚æ•°ã€‚
errorï¼šå½“åœ¨æ¥æ”¶æ•°æ®ä¸­å‡ºç°é”™è¯¯æ—¶å‘å‡ºã€‚å¯¹åº”çš„å¤„ç†å™¨å‚æ•°æ˜¯Errorçš„å®ä¾‹ï¼Œå®ƒçš„messageå±æ€§æè¿°äº†é”™è¯¯åŸå› ï¼Œstackå±æ€§ä¿å­˜äº†å‘ç”Ÿé”™è¯¯æ—¶çš„å †æ ˆä¿¡æ¯ã€‚
å¯è¯»æµè¿˜æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒä»¬è¯»å–æˆ–æ“ä½œæµï¼š
read([size])ï¼šè¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸€ä¸ªæ•´æ•°ä½œä¸ºå‚æ•°ï¼Œè¡¨ç¤ºæ‰€è¦è¯»å–æ•°æ®çš„æ•°é‡ï¼Œç„¶åä¼šè¿”å›è¯¥æ•°é‡çš„æ•°æ®ã€‚å¦‚æœè¯»ä¸åˆ°è¶³å¤Ÿæ•°é‡çš„æ•°æ®ï¼Œè¿”å›nullã€‚å¦‚æœä¸æä¾›è¿™ä¸ªå‚æ•°ï¼Œé»˜è®¤è¿”å›ç³»ç»Ÿç¼“å­˜ä¹‹ä¸­çš„æ‰€æœ‰æ•°æ®ã€‚
setEncoding(encoding)ï¼šç»™æµè®¾ç½®ä¸€ä¸ªç¼–ç æ ¼å¼ï¼Œç”¨äºè§£ç è¯»åˆ°çš„æ•°æ®ã€‚è°ƒç”¨æ­¤æ–¹æ³•åï¼Œread([size])æ–¹æ³•è¿”å›Stringå¯¹è±¡ã€‚
pause()ï¼šæš‚åœå¯è¯»æµï¼Œä¸å†å‘å‡ºdataäº‹ä»¶
resume()ï¼šæ¢å¤å¯è¯»æµï¼Œç»§ç»­å‘å‡ºdataäº‹ä»¶
pipe(destination,[options])ï¼šç»‘å®šä¸€ä¸ª Writable åˆ° readable ä¸Šï¼Œ å°†å¯å†™æµè‡ªåŠ¨åˆ‡æ¢åˆ° flowing æ¨¡å¼å¹¶å°†æ‰€æœ‰æ•°æ®ä¼ ç»™ç»‘å®šçš„ Writableã€‚æ•°æ®æµå°†è¢«è‡ªåŠ¨ç®¡ç†ã€‚è¿™æ ·ï¼Œå³ä½¿æ˜¯å¯è¯»æµè¾ƒå¿«ï¼Œç›®æ ‡å¯å†™æµä¹Ÿä¸ä¼šè¶…è´Ÿè·ï¼ˆoverwhelmedï¼‰
unpipe([destination])ï¼šè¯¥æ–¹æ³•ç§»é™¤pipeæ–¹æ³•æŒ‡å®šçš„æ•°æ®æµç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤æ‰€æœ‰çš„pipeæ–¹æ³•ç›®çš„åœ°ã€‚å¦‚æœæœ‰å‚æ•°ï¼Œåˆ™ç§»é™¤è¯¥å‚æ•°æŒ‡å®šçš„ç›®çš„åœ°ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…å‚æ•°çš„ç›®çš„åœ°ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
å¯å†™æµï¼ˆWritable streamsï¼‰
Writable streams æ˜¯ destination çš„ä¸€ç§æŠ½è±¡ï¼Œè¿™ç§ destination å…è®¸æ•°æ®å†™å…¥

writeæ–¹æ³•ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼Œwriteæ–¹æ³•è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡æ•°æ®æ˜¯å¦å¤„ç†å®Œæˆ

å¯å†™æµå¸¸ç”¨äº‹ä»¶
drain writable.write(chunk)è¿”å›falseä»¥åï¼Œå½“ç¼“å­˜æ•°æ®å…¨éƒ¨å†™å…¥å®Œæˆï¼Œå¯ä»¥ç»§ç»­å†™å…¥æ—¶ï¼Œä¼šè§¦å‘drainäº‹ä»¶
finish è°ƒç”¨endæ–¹æ³•æ—¶ï¼Œæ‰€æœ‰ç¼“å­˜çš„æ•°æ®é‡Šæ”¾ï¼Œè§¦å‘finishäº‹ä»¶ã€‚è¯¥äº‹ä»¶çš„å›è°ƒå‡½æ•°æ²¡æœ‰å‚æ•°
pipe å¯å†™æ•°æ®æµè°ƒç”¨pipeæ–¹æ³•ï¼Œå°†æ•°æ®æµå¯¼å‘å†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
unpipe å¯è¯»æ•°æ®æµè°ƒç”¨unpipeæ–¹æ³•ï¼Œå°†å¯å†™æ•°æ®æµç§»å‡ºå†™å…¥ç›®çš„åœ°æ—¶ï¼Œè§¦å‘è¯¥äº‹ä»¶
error å¦‚æœå†™å…¥æ•°æ®æˆ–pipeæ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶
å¯å†™æµå¸¸ç”¨æ–¹æ³•
write() ç”¨äºå‘â€œå¯å†™æ•°æ®æµâ€å†™å…¥æ•°æ®ã€‚å®ƒæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å†™å…¥çš„å†…å®¹ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªstreamå¯¹è±¡ï¼ˆæ¯”å¦‚å¯è¯»æ•°æ®æµï¼‰æˆ–bufferå¯¹è±¡ï¼ˆè¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œå¦ä¸€ä¸ªæ˜¯å†™å…¥å®Œæˆåçš„å›è°ƒå‡½æ•°ï¼Œå®ƒæ˜¯å¯é€‰çš„ã€‚

cork()ï¼Œuncork() corkæ–¹æ³•å¯ä»¥å¼ºåˆ¶ç­‰å¾…å†™å…¥çš„æ•°æ®è¿›å…¥ç¼“å­˜ã€‚å½“è°ƒç”¨uncorkæ–¹æ³•æˆ–endæ–¹æ³•æ—¶ï¼Œç¼“å­˜çš„æ•°æ®å°±ä¼šåå‡ºã€‚

setDefaultEncoding()ç”¨äºå°†å†™å…¥çš„æ•°æ®ç¼–ç æˆæ–°çš„æ ¼å¼ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºç¼–ç æ˜¯å¦æˆåŠŸï¼Œå¦‚æœè¿”å›falseå°±è¡¨ç¤ºç¼–ç å¤±è´¥ã€‚

end()ç”¨äºç»ˆæ­¢â€œå¯å†™æ•°æ®æµâ€ã€‚è¯¥æ–¹æ³•å¯ä»¥æ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œå…¨éƒ¨éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æœ€åæ‰€è¦å†™å…¥çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯streamå¯¹è±¡æˆ–bufferå¯¹è±¡ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™å…¥ç¼–ç ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œfinishäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚

ç®¡é“æµ
ç®¡é“æä¾›äº†ä¸€ä¸ªè¾“å‡ºæµåˆ°è¾“å…¥æµçš„æœºåˆ¶ã€‚é€šå¸¸æˆ‘ä»¬ç”¨äºä»ä¸€ä¸ªæµä¸­è·å–æ•°æ®å¹¶å°†æ•°æ®ä¼ é€’åˆ°å¦å¤–ä¸€ä¸ªæµä¸­>(æˆ‘ä»¬æŠŠæ–‡ä»¶æ¯”ä½œè£…æ°´çš„æ¡¶ï¼Œè€Œæ°´å°±æ˜¯æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨ä¸€æ ¹ç®¡å­(pipe)è¿æ¥ä¸¤ä¸ªæ¡¶ä½¿å¾—æ°´ä»ä¸€ä¸ªæ¡¶æµå…¥å¦ä¸€ä¸ªæ¡¶ï¼Œè¿™æ ·å°±æ…¢æ…¢çš„å®ç°äº†å¤§æ–‡ä»¶çš„å¤åˆ¶è¿‡ç¨‹)

åƒè¨€ä¸‡è¯­æŠµä¸è¿‡è¿™å›¾ï¼š

Node pipe

é“¾å¼æµ
é“¾å¼æ˜¯é€šè¿‡è¿æ¥è¾“å‡ºæµåˆ°å¦å¤–ä¸€ä¸ªæµå¹¶åˆ›å»ºå¤šä¸ªå¯¹ä¸ªæµæ“ä½œé“¾çš„æœºåˆ¶ã€‚é“¾å¼æµä¸€èˆ¬ç”¨äºç®¡é“æ“ä½œã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ˜¯ç”¨ç®¡é“å’Œé“¾å¼æ¥å‹ç¼©æ–‡ä»¶ åˆ›å»º compress.js æ–‡ä»¶, ä»£ç å¦‚ä¸‹ï¼š

const fs = require("fs");
const zlib = require('zlib')

// å‹ç¼© README.md æ–‡ä»¶ä¸º README.md.gz
fs.createReadStream('./README.md')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('README.md.gz'))
  
console.log("æ–‡ä»¶å‹ç¼©å®Œæˆ")
åœ¨fsä¸­ä½¿ç”¨Stream
åœ¨ä»‹ç»å®Œstreamåæˆ‘ä»¬ç”¨æµæ¥å®ç°æ–‡ä»¶è¯»å–

const fs = require("fs")

//å¯è¯»æ•°æ®æµ
//==========================================
let data = ''
//åˆ›å»ºå¯è¯»æµ
let readerStream = fs.createReadStream('./README.md')

// è®¾ç½®ç¼–ç ä¸º utf8
readerStream.setEncoding('UTF8')

// å¤„ç†æµäº‹ä»¶ --> data, end, and error
readerStream.on('data', function(chunk) {
   data += chunk
})

readerStream.on('end',function(){
   console.log(data)
})

readerStream.on('error', function(err){
   console.log(err.stack)
})

console.log("ç¨‹åºæ‰§è¡Œå®Œæ¯•")
å¤§è‡´ä»‹ç»äº†Nodeçš„Stream(æµ)å¾ˆå°‘éœ€è¦ç›´æ¥ä½¿ç”¨ stream æ¨¡å—ï¼Œæ›´å¤šä¿¡æ¯å‚è€ƒNodeä¸­æ–‡ç½‘

ä¸‹é¢æˆ‘ä»¬å°±è¿›å…¥ä»Šå¤©çš„å®ä¾‹å°é¡¹ç›®ï¼šå®ç°æ–‡ä»¶çš„å¤åˆ¶åŠŸèƒ½

2.é€šè¿‡Streamå®ç°æ–‡ä»¶å¤åˆ¶åŠŸèƒ½
æœ¬ä¾‹å‚è€ƒ chshouyuï¼šnodejsä¸­æµ(stream)çš„ç†è§£

Nodeçš„ fs æ¨¡å—å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ª copy çš„æ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°ä¸€ä¸ªã€‚

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹åœ¨ä¸çŸ¥é“æµä¹‹å‰æˆ‘ä»¬ä¼šæ€ä¹ˆåšï¼š

const fs = require('fs')
const file = fs.readFileSync('./README.md', {encoding: 'utf8'})
fs.writeFileSync('./TEST.md', file)
è¿™ç§æ–¹å¼æ˜¯æŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»å…¥å†…å­˜ï¼Œç„¶åå†å†™å…¥æ–‡ä»¶ï¼Œå¯¹äºå°å‹çš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™æ²¡æœ‰å¤šå¤§é—®é¢˜ã€‚ä½†å¯¹å¤§æ–‡ä»¶æ¥è¯´è¦èŠ±å¾ˆé•¿æ—¶é—´ï¼Œæ‰èƒ½è¿›å…¥æ•°æ®å¤„ç†çš„æ­¥éª¤ã€‚ç”šè‡³å¼•èµ·å†…å­˜çˆ†ä»“

æ—¢ç„¶æˆ‘ä»¬å­¦äº†Streamï¼Œç°åœ¨æˆ‘ä»¬å°±ç”¨Streamæ¥å®ç°è¿™ä¸ªç®€å•çš„åŠŸèƒ½ï¼š

1. ç®€å•å®ç°æ–‡ä»¶çš„å¤åˆ¶
const fs = require('fs')

let pathname = {
    src: './copy.js',
    dist: './test.js'
}

let ReadStream = fs.createReadStream(pathname.src)
let WriteStream = fs.createWriteStream(pathname.dist)

ReadStream.pipe(WriteStream)

// å¤åˆ¶å®Œæˆè§¦å‘çš„äº‹ä»¶
WriteStream.on('finish', ()=>{
    console.log('å¤åˆ¶å®Œæˆ')
})
æˆ‘ä»¬å¯ä»¥é€šè¿‡ç®¡é“æµå¾ˆæ–¹ä¾¿çš„å®ç°å•ä¸ªæ–‡ä»¶çš„å¤åˆ¶ã€‚

2.æ·»åŠ æ˜¾ç¤ºå¤„ç†çŠ¶æ€çš„åŠŸèƒ½
è¿™é‡Œå¾ˆç®€å•å°±ç›´æ¥è´´ä»£ç äº†ã€‚

const fs = require('fs')
const out = process.stdout

let paths = {
    src: '../test/test.mp4',
    dist: '../test1.mp4'
}

function copy(paths){
    let {src, dist} = paths
    let readStream = fs.createReadStream(src)
    let writeStream = fs.createWriteStream(dist)
    
    let stat = fs.statSync(src),
        totalSize = stat.size,
        progress = 0,
        lastSize = 0,
        startTime = Date.now()

    readStream.on('data', function(chunk) {
        progress += chunk.length;
    })

    // æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªé€’å½’çš„setTimeoutæ¥åšä¸€ä¸ªæ—è§‚è€…
    // æ¯500msè§‚å¯Ÿä¸€æ¬¡å®Œæˆè¿›åº¦ï¼Œå¹¶æŠŠå·²å®Œæˆçš„å¤§å°ã€ç™¾åˆ†æ¯”å’Œå¤åˆ¶é€Ÿåº¦ä¸€å¹¶å†™åˆ°æ§åˆ¶å°ä¸Š
    // å½“å¤åˆ¶å®Œæˆæ—¶ï¼Œè®¡ç®—æ€»çš„è€—è´¹æ—¶é—´
    setTimeout(function show() {
        let percent = Math.ceil((progress / totalSize) * 100)
        let size = Math.ceil(progress / 1000000)
        let diff = size - lastSize
        lastSize = size
        out.clearLine()
        out.cursorTo(0)
        out.write(`å·²å®Œæˆ${size}MB,${percent}%, é€Ÿåº¦ï¼š${diff * 2}MB/s`)
        if (progress < totalSize) {
            setTimeout(show, 500)
        } else {
            let endTime = Date.now()
            console.log(`å…±ç”¨æ—¶ï¼š${(endTime - startTime) / 1000}ç§’ã€‚`)
        }
    }, 500)
}

copy(paths)
åˆ°æ­¤æˆ‘ä»¬å°±ç”¨æµæ¥å¤„ç†äº†æ–‡ä»¶å¤åˆ¶ã€‚å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥å¤„ç†HTTP requests, on the clientã€HTTP responses, on the serverã€ fs write streamsã€zlib streamsã€crypto streamsã€TCP socketsã€ child process stdinã€ process.stdout, ã€process.stderrï¼Œå¤§å®¶å¯ä»¥è‡ªå·±è¯•è¯•ã€‚

å¯¹æ‰€æœ‰æµæ¥è¯´ï¼Œé€šå¸¸ä½¿ç”¨pipeæ–¹æ³•æ›´ä¸ºç®€ä¾¿ç›´æ¥

æœ¬æ–‡ä»‹ç»äº†Streamçš„ä¸€äº›åŸºç¡€ï¼Œå¹¶ç”¨å®ƒå®ç°äº†ä¸€ä¸ªå°çš„æ–‡ä»¶å¤åˆ¶åŠŸèƒ½ã€‚è¿™æ˜¯åªæ˜¯å…¥é—¨å°æ–‡æ¡£ï¼Œå…³äºNodeçš„Streamæ›´å¤šçš„çŸ¥è¯†ï¼Œéœ€è¦å¤§å®¶è‡ªå·±å»äº†è§£

æŠ›ç –å¼•ç‰

ç›¸å…³è¿æ¥
GitHubåœ°å€
Nodeä¸­æ–‡ç½‘
é˜®ä¸€å³°
nodejsä¸­æµ(stream)çš„ç†è§£
Â© 2022 GitHub, Inc.
Terms
Privacy
Security
Status
Docs
Contact GitHub
Pricing
API
Training
Blog
About
Loading complete


